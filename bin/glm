#!/usr/bin/env bash
set -euo pipefail

GLM_SCRIPT="$(readlink -f "$0" 2>/dev/null || realpath "$0")"
GLM_ROOT="$(cd "$(dirname "$GLM_SCRIPT")/.." && pwd)"
export GLM_ROOT GLM_SCRIPT

# Source modules
source "$GLM_ROOT/lib/log.sh"
source "$GLM_ROOT/lib/config.sh"
source "$GLM_ROOT/lib/flags.sh"
source "$GLM_ROOT/lib/prompt.sh"
source "$GLM_ROOT/lib/jobs.sh"
source "$GLM_ROOT/lib/claude.sh"
for f in "$GLM_ROOT/lib/commands/"*.sh; do source "$f"; done

# Initialize
load_config
load_credentials
check_dependencies
init_counter
reconcile_counter

usage() {
    cat <<'USAGE'
Usage: glm {session|run|start|status|result|log|list|clean|kill|update} [options]

Commands:
  session [flags] [claude flags]                 Interactive Claude Code
  run   [flags] "prompt"                         Sync execution
  start [flags] "prompt"                         Async execution
  status  JOB_ID                                 Check job status
  result  JOB_ID                                 Get text output
  log     JOB_ID                                 Show file changes
  list                                           List all jobs
  clean   [--days N]                             Remove old jobs
  kill    JOB_ID                                 Terminate job
  update                                         Self-update from GitHub

Flags:
  -d DIR              Working directory
  -t SEC              Timeout in seconds
  -m, --model MODEL   Set all three model slots to MODEL
  --opus MODEL        Set opus model
  --sonnet MODEL      Set sonnet model
  --haiku MODEL       Set haiku model
  --unsafe            Bypass all permission checks
  --mode MODE         Set permission mode (acceptEdits, default, plan)

Config: ~/.config/GoLeM/glm.conf
  GLM_MODEL=glm-4.7                # default for all slots
  GLM_OPUS_MODEL=glm-4.7           # override opus
  GLM_SONNET_MODEL=glm-4.7         # override sonnet
  GLM_HAIKU_MODEL=glm-4.7          # override haiku
  GLM_PERMISSION_MODE=acceptEdits  # default permission mode
  GLM_MAX_PARALLEL=3               # max concurrent agents (0=unlimited)

Per-job files:
  stdout.txt       Text result
  changelog.txt    File modifications log
  raw.json         Full JSON with all tool calls
USAGE
}

# Dispatch
case "${1:-}" in
    run|start|status|result|log|list|clean|kill|update|session)
        cmd="cmd_${1}"; shift; "$cmd" "$@" ;;
    _install)   shift; cmd_self_install "$@" ;;
    _uninstall) shift; cmd_self_uninstall "$@" ;;
    *)          usage; exit 1 ;;
esac
